name: Security Badges

on: push

jobs:

  analyze-alerts:
    outputs:
      dependabot-count: ${{ steps.count.outputs.dependabot-alert-count }}
      code-scanning-count: ${{ steps.count.outputs.code-scanning-alert-count }}
      secret-scanning-count: ${{ steps.count.outputs.secret-scanning-alert-count }}
    permissions:
      security-events: read
    runs-on: ubuntu-latest
    steps:
      - name: Get Alert Counts
        id: count
        uses: tuckerweibell/security-badge-action@main
        with: 
          token: ${{ secrets.PAT_TOKEN }}

  dependabot-badge:
    needs: analyze-alerts
    env:
      dependabot-count: ${{ needs.analyze-alerts.outputs.dependabot-count }}
    runs-on: ubuntu-latest
    steps:
    - name: Update Dependabot Badge
      uses: schneegans/dynamic-badges-action@v1.7.0
      with:
        auth: ${{ secrets.PAT_TOKEN }}
        gistID: ${{ secrets.GIST_ID }}
        filename: ${{ secrets.RAND_STRING }}-dependabot.json
        label: Dependabot
        message: ${{env.dependabot-count}}
        valColorRange: ${{env.dependabot-count}}
        maxColorRange: 20
        minColorRange: 0
        invertColorRange: true
        cacheSeconds: 300

  code-scanning-badge:
    needs: analyze-alerts
    env:
      code-scanning-count: ${{ needs.analyze-alerts.outputs.code-scanning-count }}
    runs-on: ubuntu-latest
    steps:
    - name: Update Code Scanning Badge
      uses: schneegans/dynamic-badges-action@v1.7.0
      with:
        auth: ${{ secrets.PAT_TOKEN }}
        gistID: ${{ secrets.GIST_ID }}
        filename: ${{ secrets.RAND_STRING }}-code-scanning.json
        label: Code Scanning
        message: ${{env.code-scanning-count}}
        valColorRange: ${{env.code-scanning-count}}
        maxColorRange: 1
        minColorRange: 0
        invertColorRange: true
        cacheSeconds: 300

  secret-scanning-badge:
    needs: analyze-alerts
    env:
      secret-scanning-count: ${{ needs.analyze-alerts.outputs.secret-scanning-count }}
    runs-on: ubuntu-latest
    steps:
    - name: Update Secret Scanning Badge
      uses: schneegans/dynamic-badges-action@v1.7.0
      with:
        auth: ${{ secrets.PAT_TOKEN }}
        gistID: ${{ secrets.GIST_ID }}
        filename: ${{ secrets.RAND_STRING }}-secret-scanning.json
        label: Secret Scanning
        message: ${{env.secret-scanning-count}}
        valColorRange: ${{env.secret-scanning-count}}
        maxColorRange: 1
        minColorRange: 0
        invertColorRange: true
        cacheSeconds: 300
        
